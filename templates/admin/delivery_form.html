{% extends 'admin/base.html' %}

{% block body %}

<br>
<br>
<div style="border: 2px solid black; padding:20px"
     id="delivery-product-form" >
    <div class="row d-flex justify-content-between">
        <div>
             <h4> <b>ANNNPTT electronics </b></h4>
             <p> 273 An Dương Vương, Phường 3, Quận 5, TP Hồ Chí Minh</p>
        </div>
        <div class="text-right">
             <h4 class="text-center"> <b>Mẫu số 01-VT </b></h4>
            <p class="text-center"> (Ban hành theo Thông tư số 200/2014/TT-BTC </p>
            <p class="text-left"> Ngày 22/12/2014 của Bộ Tài chính )</p>
        </div>
    </div>


    <h1 class="text-center text-dark mt-5"><b>Phiếu xuất kho </b> </h1>
        <h5 class="text-center text-dark"> <i>{{ now.strftime('Ngày %d tháng %m năm %Y') }}</i></h5>
        <h5 class="text-center text-dark mb-4"><b> Số: {{ delivery_code }} </b></h5>



    <form action="" method="POST">
        <div class="form-group form-inline d-flex justify-content-between">
            <div class="form-inline">
                <label>Họ và tên người nhận hàng </label>
                <input type="text"
                       readonly
                       class="form-control ml-3"
                       value="{{ receipt.customer_name }}">
            </div>

             <div class="form-inline">
                <label>Địa chỉ (bộ phận): </label>
                 <input type="text"
                        readonly
                        class="form-control ml-3">
            </div>
        </div>

        <div class="form-group form-inline">
            <label>Lý do xuất kho: </label>
            <input readonly
                   type="text"
                   class="form-control ml-3"
                   value="Xuất bán">
        </div>

        <div class="form-group form-inline">
            <div class="form-inline">
                <label>Xuất tại kho (ngăn lô):  </label>
                <input type="text" class="border border-0" value="Hàng Hóa">
            </div>
            <div class="form-inline">
                <label class="ml-5">Địa điểm:  273 An Dương Vương, Phường 3, Quận 5, TP Hồ Chí Minh</label>
            </div>
        </div>

        <table class="table table-bordered text-center">
          <thead>
                <tr style="background-color:lightyellow;">
                  <th scope="col" rowspan="2">STT</th>
                  <th scope="col" rowspan="2">Tên sản phẩm</th>
                  <th scope="col" rowspan="2">Mã số</th>
                  <th scope="col" rowspan="2">Đơn vị tính</th>
                  <th scope="col" colspan="2">Số lượng </th>
                  <th scope="col" rowspan="2">Đơn giá</th>
                  <th scope="col" rowspan="2">Thành tiền</th>
                    <th scope="col" rowspan="2"> Ghi chú </th>
                </tr>
                <tr>
                        <td  style="background-color:lightyellow; font-weight:bold;">Yêu cầu</td>
                        <td  style="background-color:lightyellow; font-weight:bold">Thực xuất</td>
                </tr>
          </thead>
          <tbody>

              {% for r in receipt_details %}
                <tr>
                  <th scope="row">{{ loop.index }}</th>
                  <td>{{ r.product_name }}</td>
                  <td>
                      <input type="text"
                             readonly
                             name="product_id_{{r.product_id}}"
                             value="{{ r.product_id }}"
                             class="form-control text-center">
                      </td>
                  <td>Cái</td>
                  <td>
                      <input type="text"
                             readonly
                             class="form-control text-center"
                             name="base_quantity_{{ r.product_id }}"
                             value="{{ r.quantity }}">
                  </td>
                    <td>
                        {% if receipt.exported %}
                            {% if r.delivered_quantity %}
                             <input type="number"
                                   class="form-control"
                                   name="quantity_{{ r.product_id }}"
                                   value="{{ r.delivered_quantity }}">
                            {% else %}
                            <input type="number"
                                   class="form-control"
                                   name="quantity_{{ r.product_id }}"
                                   placeholder="Nhập số lượng thực xuất" required>
                            {% endif %}
                        {% else %}
                            <input type="number"
                                   class="form-control"
                                   name="quantity_{{ r.product_id }}"
                                   placeholder="Nhập số lượng thực xuất" required>
                        {% endif %}

                    </td>
                    {% if receipt.exported %}
                        <td>{{ "{:,.0f}".format(r.unit_price) }}đ</td>
                        {% set quantity = r.delivered_quantity | int %}
                        {% set price = r.unit_price | float %}
                        <td>{{ "{:,.0f}".format(quantity * price) }}đ</td>
                        <td>
                            <textarea name="note" class="form-control">
                            </textarea>
                        </td>
                    {% else %}
                        <td>{{ "{:,.0f}".format(r.unit_price) }}đ</td>
                        {% set quantity = r.quantity | int %}
                        {% set price = r.unit_price | float %}
                        <td>{{ "{:,.0f}".format(quantity * price) }}đ</td>
                        <td>
                            <textarea name="note" class="form-control">
                            </textarea>
                        </td>
                    {% endif %}
                </tr>
              {% endfor %}
                <tr class="font-weight-bold" style="background-color: lightgreen">
                    <th scope="row"></th>
                    <td>Cộng</td>
                    <td>X</td>
                    <td>X</td>
                    <td>X</td>
                    <td>X</td>
                    <td>X</td>
                    <td>{{ total_price }}</td>
                    <td></td>
                </tr>
          </tbody>
        </table>

        <br>
        <p>Tổng số tiền (<i>Viết bằng chữ</i>): {{ total_in_words }} </p>
        <p>Số chứng từ gốc kèm theo: 01 HĐ GTGT số 0000256</p>

        <br>
        <div class="row d-flex justify-content-around">
            <div class="form-group ml-3 text-center mt-5">
                <label> <b>Người lập phiếu </b></label>
                <p><i>(Ký, họ tên )</i></p>
                <p>{{ current_user.name }}</p>
            </div>
            <div class="form-group ml-3 text-center mt-5">
                <label> <b>Người nhận hàng </b></label>
                <p><i>(Ký, họ tên )</i></p>
            </div>
            <div class="form-group ml-3 text-center mt-5">
                <label> <b>Thủ kho</b></label>
                <p><i>(Ký, họ tên )</i></p>
                <p>
                    <input type="text" class="form-control">
                </p>
            </div>
            <div class="form-group ml-3 text-center mt-2">
                <p><i>{{ now.strftime('Ngày %d tháng %m năm %Y') }}</i></p>
                <label> <b>Giám đốc</b></label>
                <p><i>(Ký, họ tên, đóng dấu )</i></p>
                <p>
                    <input type="text" class="form-control">
                </p>
            </div>
        </div>
        {% if receipt.exported %}
            {% if delivery_note.confirmed == False %}
            <button  class="btn btn-warning"
                     type="button"
                     data-toggle="modal"
                     data-target="#confirmModal"
                     onclick="lastCheck()">
                    <i class="fa-solid fa-file-circle-check"></i>
                    <b>Xác nhận phiếu xuất kho</b>
            </button>
            {% else %}
            {% endif %}
        {% else %}
            <button type="submit"
                    class="btn btn-dark text-light" >
                    <i class="fa-solid fa-folder-plus"></i>
                    <b>Tạo phiếu xuất kho</b>
            </button>
            <button  class="btn btn-warning"
                     type="button"
                     data-toggle="modal"
                     data-target="#confirmModal"
                     onclick="lastCheck()">
                    <i class="fa-solid fa-file-circle-check"></i>
                    <b>Tạo & xác nhận phiếu xuất kho</b>
            </button>
        {% endif %}
        <a      href="{{ url_for('receipt.index') }}"
                class="btn btn-dark text-light" >
                <i class="fa-solid fa-right-from-bracket"></i>
                <b>Quay lại</b>
        </a>
    </form>
</div>

<br>
<br>
<!-- Modal -->
<form action="" method="POST">
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Xác nhận phiếu xuất kho</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
          <div class="alert alert-danger" role="alert" id="alert">
          </div>


        Bạn có chắc chắn muốn xác nhận phiếu nhập kho với mã:
          {% if receipt.exported %}<strong>{{ delivery_note.code }}</strong>  ?
          {% else %} <strong>{{ delivery_code }}</strong>  ?
          {% endif %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Hủy</button>
        <button type="submit"
                class="btn btn-warning"
                formaction="">
            Xác nhận
        </button>
      </div>
    </div>
  </div>
</div>
</form>


<script src="https://kit.fontawesome.com/577b2b59fe.js" crossorigin="anonymous"></script>
<script>

    lastCheck = () =>{
        if ( Check() == false){
            document.querySelector('#alert').style.display = 'block'
            document.querySelector('#alert').innerHTML = "<strong>Có sản phẩm có số lượng thực xuất chưa đủ với số lượng yêu cầu, hãy chắc rằng bạn đã kiểm tra số lượng trước khi tạo phiếu xuất kho nhé !</strong>"
        }
        else {
            document.querySelector('#alert').style.display = 'none'
        }
    }

    Check = () =>{
        const baseQuantity = []
        const receivedQuantity = []
           document.querySelectorAll('input[name^="base_quantity_"]').forEach(input =>{
                if (input.value > 0){
                    baseQuantity.push(input.value)
                }}
           )
           document.querySelectorAll('input[name^="quantity_"]').forEach(input =>{
            if (input.value > 0){
                receivedQuantity.push(input.value)
            }}
       )

        if ( baseQuantity.length !== receivedQuantity.length )
            return false

        for ( let i = 0; i < baseQuantity.length; i++){
            if (baseQuantity[i] != receivedQuantity[i]){
                return false
            }
        }

        return true
    }
</script>
{% endblock %}

